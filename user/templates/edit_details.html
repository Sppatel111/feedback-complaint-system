{% extends "settings.html" %}
{% set active_tab = 'edit' %}

{% block settings_content %}
<!-- Custom styles for profile image and form adjustments -->
<style>
    .profile-pic-wrapper {
        position: relative;
        width: 120px;
        height: 120px;
        margin: 0 auto 1rem auto;
    }

    .profile-pic-wrapper img {
        width: 120px;
        height: 120px;
        object-fit: cover;
        border-radius: 50%;
        border: 3px solid #dee2e6;
        box-shadow: 0 0 6px rgba(0,0,0,0.1);
    }

    .upload-icon {
        position: absolute;
        bottom: 0;
        right: 0;
        background: #fff;
        border-radius: 50%;
        padding: 6px;
        cursor: pointer;
        box-shadow: 0 0 5px rgba(0,0,0,0.2);
    }

    .upload-icon:hover {
        background: #e9ecef;
    }

    input[type="file"] {
        display: none;
    }
</style>
<!-- Flash Messages -->
<div id="flash-wrapper">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% for category, message in messages %}
            <div class="flash-toast {{ category }}">
                <span class="icon">
                    {% if category == 'success' %}<i class="fas fa-check-circle icon"></i>
                    {% elif category == 'danger' %}	<i class="fas fa-times-circle icon"></i>
                    {% elif category == 'warning' %}<i class="fas fa-exclamation-triangle icon"></i>
                    {% elif category == 'info' %}<i class="fas fa-circle-info icon"></i>
                    {% else %}ðŸ””
                    {% endif %}
                </span>
                <span>{{ message }}</span>
            </div>
        {% endfor %}
    {% endwith %}
</div>
<div class="container mt-5">
    <div class="card shadow-lg border-0">
        <div class="card-body">
            <h4 class="card-title mb-4 ">Edit Your Details</h4>

            <form method="POST" enctype="multipart/form-data">
                {{ form.hidden_tag() }}

                <div class="text-center mb-3">
                    <div class="profile-pic-wrapper">
                        <img id="profile-preview"
                             src="{{ url_for('user.static', filename='assets/profiles/' + (current_user.user_detail.profile_image or 'default-profile.jpg')) }}"
                             alt="Profile Image">
                        <label for="profileImage" class="upload-icon border">
                            <i class="fas fa-camera"></i>
                        </label>
                        {{ form.profile_image(id='profileImage') }}
                    </div>
                    <small class="text-muted">Click the icon to change profile picture</small>
                </div>

                <!-- Email and Department (readonly) -->
                <div class="form-group">
                    {{ form.email.label(class="form-label") }}
                    {{ form.email(class="form-control", readonly=True) }}
                </div>

                <div class="form-group">
                    {{ form.department.label(class="form-label") }}
                    {{ form.department(class="form-control", readonly=True) }}
                </div>

                <!-- Name Fields (First Name and Last Name) -->
                <div class="form-row">
                    <div class="form-group col-md-6">
                        {{ form.f_name.label(class="form-label") }}
                        {{ form.f_name(class="form-control") }}
                    </div>
                    <div class="form-group col-md-6">
                        {{ form.l_name.label(class="form-label") }}
                        {{ form.l_name(class="form-control") }}
                    </div>
                </div>
                <!-- Phone Number Field -->
                <!-- Phone Number with Country Code Dropdown -->
                <div class="form-group">
                    {{ form.phone.label(class="form-label") }}
                    {{ form.phone(id='phone', class="form-control", type="hidden") }}
                    <input type="tel" id="phone_input" class="form-control" />
                    {% for error in form.phone.errors %}
                            <div class="text-danger small">{{ error }}</div>
                        {% endfor %}
                </div>

                <br>
                <!-- Submit Button -->
                <button type="submit" class="btn btn-lg btn-outline-primary d-flex align-items-center mt-2
                        shadow-sm hover-shadow-lg transition-all duration-300 px-4 py-2 rounded-3">
                    <i class="fas fa-save fa-lg"></i>
                    <span class="ml-2" style="font-weight: bold;">Update Details</span>
                </button>

            </form>
        </div>
    </div>
</div>
<!-- phone number with country code selected -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const input = document.querySelector("#phone_input");
        const hiddenInput = document.querySelector("#phone");

        const iti = window.intlTelInput(input, {
            separateDialCode: true,
            utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/16.0.4/js/utils.js"
        });

        // Populate the visible input if there's already a value
        if (hiddenInput.value) {
            iti.setNumber(hiddenInput.value);
        }

        // On form submit, update hidden field before sending
        const form = input.closest("form");
        form.addEventListener("submit", function () {
            const fullNumber = iti.getNumber(); // Gets full international format
            hiddenInput.value = fullNumber;
        });
    });
</script>

<!-- Preview the profile picture when selected -->
<script>
    const input = document.getElementById('profileImage');
    const preview = document.getElementById('profile-preview');

    input.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
            preview.src = URL.createObjectURL(file);
        }
    });
</script>

{% endblock %}
